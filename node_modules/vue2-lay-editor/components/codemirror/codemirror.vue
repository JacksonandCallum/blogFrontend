<template>
  <div :id="scoped" class="codemirror lay-editor-codemirror">
    <div class="codemirror-main">
      <codemirror
        ref="codemirror"
        v-model="codemirrorValue"
        :options="options"
        @ready="onCmReady"
      >
      </codemirror>
    </div>
  </div>
</template>

<script>
// 安装 : "vue-codemirror": "^4.0.6"
import { js_beautify, css_beautify, html_beautify } from "js-beautify";
import { codemirror } from "vue-codemirror";
import "codemirror/lib/codemirror.css";
// 语言/主题
import langs from "./langs";
import theme from "./theme";

const createUid = (() => {
  let regxy = /[xy]/g;
  let reg = /-/g;
  let empty = "";
  return () => {
    let uuid = "xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(
      regxy,
      function (c) {
        var r = (Math.random() * 16) | 0,
          v = c == "x" ? r : (r & 0x3) | 0x8;
        return v.toString(16);
      }
    );
    return uuid.replace(reg, empty);
  };
})();
export default {
  model: {
    prop: "value",
    event: "input",
  },
  props: {
    value: {},
    // 主题
    theme: {
      default: "one-dark",
    },
    // 语言
    lang: {
      default: "javascript",
    },
    styles: {
      default() {
        return {
          width: "100%",
          height: "auto",
          minHeight: "50px",
        };
      },
    },
  },
  components: {
    codemirror,
  },
  data() {
    return {
      codemirrorValue: `
        options: {
          tabSize: 4, // tabsize默认为4
          // 行号
          lineNumbers: true,
          // lint: true,
          indentUnit: 4,
          // lineWrapping: true, // 自动换行
          // 选择代码语言
          mode: "text/javascript",
          // 主题根据需要自行配置
          theme: "one-dark",
          //自动提示配置
          // extraKeys: { Ctrl: "autocomplete" },
          readOnly: false, // 是否只读
          smartIndent: false,
          indentWithTabs: true,
          // matchBrackets: true, // 括号匹配
          // styleActiveLine: true, // line选择是是否加亮
  
          // origLeft: null,
          // connect: "align",
          // collapseIdentical: false,
          // highlightDifferences: true,
          // foldGutter: true,
  
          // autofocus: false, // 初始化的时候是否自动获取焦点
          // gutters: [
          //   "CodeMirror-linenumbers",
          //   "CodeMirror-foldgutter",
          //   "CodeMirror-lint-markers",
          // ],
        },`,

      scoped: "token" + createUid(),
      options: {
        tabSize: 2, // tabsize默认为4
        indentUnit: 2, // 缩进
        // 行号
        lineNumbers: true,
        // 选择代码语言
        mode: "",
        // 主题根据需要自行配置
        theme: "",
        //自动提示配置
        readOnly: false, // 是否只读
        smartIndent: false, // 根据上下文自动缩进 - (关闭避免换行缩进)
        styleActiveLine: true, // line选择是是否加亮
        autofocus: false, // 自动获取焦点
        // lineWrapping: true, // 自动换行
        // matchBrackets: true, // 括号匹配
        extraKeys: {
          // 缩进
          Tab: (cm) => {
            if (cm.somethingSelected()) {
              // 存在文本选择
              cm.indentSelection("add"); // 正向缩进文本
            } else {
              // 无文本选择
              // cm.indentLine(cm.getCursor().line, "add"); // 整行缩进 不符合预期
              // 光标处插入 indentUnit 个空格
              cm.replaceSelection(
                Array(cm.getOption("indentUnit") + 1).join(" "),
                "end",
                "+input"
              );
            }
          },
          // 反向缩进
          "Shift-Tab": (cm) => {
            // cm.setValue(js_beautify(cm.getValue()));
            if (cm.somethingSelected()) {
              // 存在文本选择
              cm.indentSelection("subtract"); // 反向缩进
            } else {
              // 无文本选择
              // cm.indentLine(cm.getCursor().line, "subtract"); // 直接缩进整行
              const cursor = cm.getCursor();
              // 光标回退 indexUnit 字符
              cm.setCursor({ line: cursor.line, ch: cursor.ch - 4 });
            }
          },
          // 格式化代码
          "Alt-F": (cm) => {
            if (this.lang.indexOf("javascript") != -1) {
              cm.setValue(js_beautify(cm.getValue()));
            }
          },
          // 保存
          "Ctrl-S": (cm) => {
            if (this.lang.indexOf("javascript") != -1) {
              cm.setValue(js_beautify(cm.getValue()));
            }
          },
        },
      },
    };
  },
  mounted() {
    let lang = langs.find((item) => this.lang == item.name) || {};
    this.setTheme(this.theme);
    this.setMode(lang.id);
    this.updateStyle();
  },
  watch: {
    lang() {
      let lang = langs.find((item) => this.lang == item.name) || {};
      this.setMode(lang.id);
    },
    theme() {
      this.setTheme(this.theme);
    },
    styles() {
      this.updateStyle();
    },
    value: {
      immediate: true,
      handler() {
        this.codemirrorValue = this.value;
      },
    },
  },
  methods: {
    // 删除dom字符串下面的指定元素
    removeElementFromString(domString, elementId) {
      // 创建虚拟DOM
      var parser = new DOMParser();
      var doc = parser.parseFromString(domString, "text/html");
      // 获取指定元素
      var element = doc.querySelectorAll(elementId);
      // 删除元素
      element.forEach((i) => i.parentNode.removeChild(i));
      // 返回修改后的DOM字符串

      return doc.querySelector("body").innerHTML;
    },

    // 初始化
    onCmReady(cm) {
      // https://blog.csdn.net/mafan121/article/details/49178945?spm=1001.2101.3001.6650.14&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-14-49178945-blog-106748616.pc_relevant_3mothn_strategy_recovery&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-14-49178945-blog-106748616.pc_relevant_3mothn_strategy_recovery&utm_relevant_index=15
      // https://blog.csdn.net/weixin_30873847/article/details/95114367?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-1-95114367-blog-49178945.pc_relevant_aa2&spm=1001.2101.3001.4242.2&utm_relevant_index=4
      //  监听输入
      this.$emit("ready", {
        theme,
        langs,
      });
      cm.on("change", (data) => {
        setTimeout(() => {
          console.log(data.getValue);
          let value = data.getValue();
          // 获取code内容

          let htmlDom = document.querySelector(
            `#${this.scoped} .CodeMirror-code`
          ).innerHTML;
          // 剔除索引元素
          htmlDom = this.removeElementFromString(
            htmlDom,
            ".CodeMirror-gutter-wrapper"
          );
          htmlDom = `<div class="CodeMirror-render cm-s-one-dark"><span class="lay-lang">${this.lang}</span><div class="code-main"><div class="code-content">${htmlDom}</div></div></div>`;
          this.$emit("input", value);
          this.$emit("change", htmlDom, this.lang, value);
        });
      });
      // 输入前触发
      cm.on("beforeChange", (data) => {
        let value = data.getValue();
        this.$emit("beforeChange", value, data);
      });
      // 编辑器内容被改变时触发
      cm.on("update", (data) => {
        let value = data.getValue();
        this.$emit("update", value, data);
      });
      // 编辑器获得焦点时触发
      cm.on("focus", (value) => {
        this.$emit("focus", value);
      });
      // 编辑器获得焦点时触发
      cm.on("blur", (value) => {
        this.$emit("blur", value);
      });
      // 当按下扩展快捷键触发
      cm.on("keyHandled", (value) => {
        this.$emit("keyHandled", value);
      });
      // 快捷键设置
      cm.addKeyMap({
        // 保存
        "Ctrl-S": (cm) => {
          if (this.lang.indexOf("javascript") != -1) {
            cm.setValue(js_beautify(cm.getValue()));
          }
          this.$emit("save");
        },
      });
    },
    // 获取鼠标选中区域的代码
    getSelection() {
      return this.$refs.codemirror.codemirror.getSelection();
    },
    // 替换选中区域的代码
    replaceSelection(value) {
      this.$refs.codemirror.codemirror.replaceSelection(value);
    },
    // undo
    undo() {
      this.$refs.codemirror.codemirror.undo(js_beautify(value));
    },
    // 回退
    redo() {
      this.$refs.codemirror.codemirror.redo(js_beautify(value));
    },
    // 刷新
    refresh() {
      this.$refs.codemirror.codemirror.refresh();
    },
    // 设置编辑器大小
    setSize(width, height) {
      this.$refs.codemirror.codemirror.setSize(width, height);
    },
    // 设置编辑器内容
    setValue(value) {
      this.$refs.codemirror.codemirror.setValue(value);
    },
    // 设置只读
    setReadOnly(value) {
      this.$refs.codemirror.codemirror.setOption("readOnly", value);
    },
    // 设置语言
    setMode(value) {
      this.$refs.codemirror.codemirror.setOption("mode", value);
    },
    // 设置主题
    setTheme(value) {
      this.$refs.codemirror.codemirror.setOption("theme", value);
    },
    // 设置快捷键
    setExtraKeys(extraKeys) {
      this.$refs.codemirror.codemirror.setOption("extraKeys", {
        // Tab: function (cm) {},
        ...extraKeys,
      });
    },
    // 格式化代码
    formatCode() {
      const code = this.$refs.codemirror.codemirror.getValue();
      this.$refs.codemirror.codemirror.setValue(js_beautify(code));
    },
    // 更新样式
    updateStyle() {
      for (let item in this.styles) {
        this.$refs.codemirror.$el.style[item] = this.styles[item];
      }
      let CodeMirror = document.querySelector(`#${this.scoped} .CodeMirror`);
      let scroll = document.querySelector(`#${this.scoped} .CodeMirror-scroll`);
      let minHeight = this.styles.minHeight || "200px";
      scroll.style.minHeight = minHeight;
      CodeMirror.style.minHeight = minHeight;
      CodeMirror.style.width = "100%";
      this.$refs.codemirror.$el.style.minHeight = minHeight;
    },
  },
};
</script>

<style>
.lay-editor-codemirror .codemirror-main {
  margin: auto;
}

.lay-editor-codemirror .codemirror-main .CodeMirror {
  background: #282c34;
  height: 100% !important;
}

.lay-editor-codemirror .codemirror-main .CodeMirror-scroll {
}
.codemirror-main .CodeMirror-sizer {
  margin-bottom: 0 !important;
}

.lay-editor-codemirror .CodeMirror-scrollbar-filler,
.lay-editor-codemirror .CodeMirror-gutter-filler {
  background-color: transparent;
}

.lay-editor-codemirror .CodeMirror-hscrollbar::-webkit-scrollbar-track {
  background: transparent !important;
  background: pink;
}
.lay-editor-codemirror .CodeMirror-scroll {
  padding-bottom: 55px !important;
}
</style>
