<template>
  <div :class="['lay-editor', { fullscreen: isFullscreen }]">
    <div
      @click.stop="onMenuControl"
      class="layeditor-container"
      :style="{ width: isFullscreen ? '800px' : '100%' }"
    >
      <!-- 标题,文本,代码块,图片,链接,色块,引用,状态,对话,外链 -->
      <div class="layeditor-tools">
        <div class="layeditor-item">
          <tool-bar
            :open="isFullscreen"
            @fullscreen="fullscreen"
            @change="onBar"
          ></tool-bar>
        </div>
        <div class="layeditor-item">
          <edit-tools :range="range" :state="commandState"></edit-tools>
        </div>
      </div>
      <div id="editor-section" class="editor-section">
        <div
          @click.stop="selectEdit(index)"
          :class="['layeditor-item', { active: index == current }]"
          v-for="(item, index) in editorData"
          :key="index"
        >
          <!-- 标题 -->
          <title-card
            :token="item.token"
            @change="(data) => onEdit(data, item)"
            @commandState="onCommandState"
            v-if="item.type == 'title'"
            :themeType="item.themeType"
            :content="item.content"
            :index="index"
            :current="current"
          ></title-card>
          <!-- 文本,引用,色块,状态 -->
          <default-text
            :token="item.token"
            :themeType="item.type"
            :content="item.content"
            :index="index"
            :current="current"
            @change="(data) => onEdit(data, item)"
            @commandState="onCommandState"
            v-if="
              ['text', 'state', 'quote', 'colorblock', 'text-type-1'].includes(
                item.type
              )
            "
          ></default-text>
          <!-- 代码块 -->
          <code-block
            :token="item.token"
            v-if="item.type == 'code'"
            :content="item.content"
            @change="(data) => onEdit(data, item)"
          ></code-block>
          <!-- 图片 -->
          <image-card
            :token="item.token"
            @change="(data) => onEdit(data, item)"
            :content="item.content"
            v-if="item.type == 'image-one'"
          ></image-card>
          <!-- 链接  -->
          <link-block
            :token="item.token"
            @change="(data) => onEdit(data, item)"
            :content="item.content"
            v-if="item.type == 'link'"
          ></link-block>
          <!-- 对话 -->
          <dialogue
            :token="item.token"
            @change="(data) => onEdit(data, item)"
            :content="item.content"
            v-if="item.type == 'dialogue'"
          ></dialogue>
          <!-- 表情包 -->
          <emoticon
            :token="item.token"
            @change="(data) => onEdit(data, item)"
            :content="item.content"
            v-if="item.type == 'emoticon'"
          ></emoticon>
          <!-- 扩展 -->
          <extend-card
            :token="item.token"
            @change="(data) => onEdit(data, item)"
            :content="item.content"
            v-if="item.type == 'extend'"
          ></extend-card>
          <div
            @click.stop="onMenuControl"
            v-if="index == current"
            class="layeditor-control"
          >
            <div @click="deleteItem(index)">
              <img src="./assets/del.png" alt="" />
            </div>
            <div @click="downUp(index)">
              <img src="./assets/up.png" alt="" />
            </div>
            <div @click="downMove(index)">
              <img src="./assets/down.png" alt="" />
            </div>
          </div>
        </div>
        <div style="height: 200px"></div>
      </div>
    </div>
  </div>
</template>

<script>
const createUid = "uid";
import toolBar from "./tools";
import editTools from "./edit-tools";
import titleCard from "./temp/title/index";
import imageCard from "./temp/images/index";
import defaultText from "./temp/text/default-text";
import codeBlock from "./temp/codeBlock/codeBlock";
import linkBlock from "./temp/linkBlock/linkBlock";
import dialogue from "./temp/dialogue/dialogue";
import emoticon from "./temp/emoticon/emoticon";
import extendCard from "./temp/extendCard/extendCard";
import $publish from "./config/Publish";
import config from "./config/index";

export default {
  name: "modularEditor",
  components: {
    toolBar,
    editTools,
    titleCard,
    defaultText,
    codeBlock,
    imageCard,
    linkBlock,
    dialogue,
    emoticon,
    extendCard,
  },
  props: {
    content: {
      default() {
        return [];
      },
    },
    options: {
      default() {
        return {};
      },
    },
  },
  data() {
    return {
      editorData: [],
      commandState: [],
      range: 0, // 光标位置
      isFullscreen: false, //是否全屏
      current: null, //当前
      currentEdit: null, //当前
    };
  },

  watch: {
    content: {
      immediate: true,
      handler() {
        this.editorData = this.content;
      },
    },
    options: {
      deep: true,
      immediate: true,
      handler() {
        config.setConfig(this.options);
      },
    },
  },
  created() {
    config.setConfig(this.options);
  },
  mounted() {
    this.onPaste();
    this.onkeydown();
  },
  methods: {
    // 监听bar
    onBar(item) {
      if (
        this.currentEdit != null &&
        this.currentEdit != this.editorData.length - 1
      ) {
        this.editorData.splice(this.currentEdit + 1, 0, item);
      } else {
        this.editorData.push(item);
      }
      this.refresh();
      this.onPaste();
    },
    // 监听keydown click
    onkeydown() {
      let self = this;
      document.onkeydown = function (e) {
        if (e.key == "s") {
          self.$emit("save");
          self.refresh();
          return false;
        }
      };

      document.addEventListener("click", () => {
        self.current = null;
        self.currentEdit = null;
        this.onMenuControl();
      });
    },
    // 监听剪切板
    onPaste() {
      this.$nextTick(() => {
        setTimeout(() => {
          let richText = document.querySelectorAll(".clear-paste-style");
          richText.forEach((dom) => {
            dom.addEventListener("paste", this.optimizePasteEvent);
          });
        }, 0);
      });
    },
    // 选择编辑
    selectEdit(index) {
      this.current = index;
      this.currentEdit = index;
      this.onMenuControl();
      this.refresh();
    },
    // 监听编辑
    onEdit(data, item) {
      item.content = data;
      this.refresh();
      this.getRange();
    },
    deleteItem(index) {
      this.editorData.splice(index, 1);
      this.refresh();
    },
    downUp(index) {
      if (index == 0) return;
      let item = this.editorData.splice(index, 1);
      this.editorData.splice(index - 1, 0, item[0]);
      this.current = index - 1;
      this.currentEdit = index - 1;
      this.refresh();
    },
    downMove(index) {
      if (index == this.editorData.length - 1) return;
      let item = this.editorData.splice(index, 1)[0];
      this.editorData.splice(index + 1, 0, item);
      this.current = index + 1;
      this.currentEdit = index + 1;
      this.refresh();
    },
    refresh() {
      this.$emit("change", this.editorData);
    },
    // 监听输入状态
    onCommandState(data) {
      this.commandState = data;
    },
    fullscreen() {
      this.isFullscreen = !this.isFullscreen;
    },
    // 获取光标位置
    getRange() {
      var supportRange = typeof document.createRange === "function";
      let selection = document.getSelection(),
        range;
      if (supportRange) {
        selection = document.getSelection();
        if (selection.getRangeAt && selection.rangeCount) {
          range = document.getSelection().getRangeAt(0);
        }
      } else {
        range = document.selection.createRange();
      }
      this.range = range;
    },
    onMenuControl() {
      $publish.emit("initOpenState");
    },
    // 监听剪贴板 粘贴去除格式
    optimizePasteEvent(e) {
      e.stopPropagation();
      e.preventDefault();
      let text = "";
      const event = e.originalEvent || e;
      // 获取 剪贴板 格式化后的内容
      if (event.clipboardData && event.clipboardData.getData) {
        text = event.clipboardData.getData("text/plain");
      } else if (window.clipboardData && window.clipboardData.getData) {
        text = window.clipboardData.getData("Text");
      }
      // 插入内容
      if (document.queryCommandSupported("insertText")) {
        document.execCommand("insertHTML", true, text);
        return;
      } else if (document.execCommand) {
        document.execCommand("paste", false, text);
        return;
      }
    },
  },
};
</script>

<style lang="scss" scoped>
.lay-editor {
  height: 100%;
}

.lay-editor .layeditor-container {
  height: 100%;
  display: flex;
  flex-direction: column;
  margin: auto;
}

.fullscreen {
  width: 100%;
  height: 100%;
  position: fixed;
  left: 0;
  top: 0;
  background: #f5f5f5;
  z-index: 999;
}

.lay-editor .layeditor-tools {
  padding: 10px 0;
  background: #fff;
  // border-bottom: 1px solid #eee;
}
.lay-editor .layeditor-tools .layeditor-item {
  padding: 0 10px;
  border-bottom: 1px solid #f5f5f5;
}

.lay-editor .editor-section {
  flex: 1;
  overflow: auto;
  background: #fff;
  background-image: linear-gradient(
      90deg,
      rgba(60, 10, 30, 0.04) 3%,
      transparent 0
    ),
    linear-gradient(1turn, rgba(60, 10, 30, 0.04) 3%, transparent 0);
  background-size: 20px 20px;
  background-position: 50%;
}

.editor-section .layeditor-item {
  border: 2px dotted transparent;
  margin-top: 2px;
  position: relative;
}

.editor-section .active {
  border-color: #ccc;
}

.editor-section .layeditor-control {
  position: absolute;
  top: -2px;
  right: -2px;
  background: #f5f5f5;
  border: 2px dotted #ccc;
  cursor: pointer;
  display: flex;
  // padding: 5px;
}
.editor-section .layeditor-control div {
  width: 25px;
  height: 25px;
  margin-left: 10px;
}
.editor-section .layeditor-control img {
  width: 100%;
  height: 100%;
}
.editor-section .layeditor-control div:hover {
  background: #fff;
}

/*滚动条样式*/
#editor-section {
  ::-webkit-scrollbar {
    // width: 4px;
    // height: 4px;
  }
  ::-webkit-scrollbar-thumb {
    border-radius: 10px;
    // background: rgb(224, 224, 224);
  }
  ::-webkit-scrollbar-track {
    border-radius: 0;
    // background: #eee;
  }
}
</style>
