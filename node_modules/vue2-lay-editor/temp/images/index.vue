<template>
  <div ref="image" class="image-one">
    <div ref="imgbox" class="image-one-section">
      <div class="image-one-content">
        <div
          v-if="src"
          class="image-item"
          :style="{
            width: currentW + '%',
          }"
        >
          <img ref="img" @load="onImage" :src="src" alt="" />
          <!-- 删除图片 -->
          <div @click="deleteImg" class="del">
            <img src="../../assets/del.png" alt="" />
          </div>
          <!-- 图片上传状态 -->
          <div class="loading-state" v-if="loadingState > 0">
            <loading v-if="loadingState == 1"></loading>
            <span v-if="loadingState == 2">上传成功</span>
            <span @click="uploadImg" class="upload-err" v-if="loadingState == 3"
              >上传失败,重新上传</span
            >
          </div>

          <div class="control">
            <span @click="amplify">放大</span>
            <span @click="reduceImg">缩小</span>
          </div>
        </div>
        <div v-else class="select-image">
          <input
            class="file"
            type="file"
            @change="onSelectImg"
            accept="image/*"
          />
          点击选择图片
        </div>
      </div>
      <div class="tips">
        <input
          @input="onChange"
          v-model="tips"
          placeholder="图片描述信息"
          type="text"
        />
      </div>
      <div ref="aaa"></div>
    </div>
  </div>
</template>

<script>
import config from "../../config/index";
import loading from "../../components/loading.vue";
export default {
  name: "title-large",
  components: {
    loading,
  },
  props: {
    content: {
      default() {
        return {};
      },
    },
    token: {
      default: "",
    },
  },
  data() {
    return {
      file: null,
      maxWidth: 0,
      currentW: "",
      tips: "",
      src: "",
      loadingState: 0, // 0不需要上传,1:上传中,2上传成功,3上传失败
    };
  },
  async mounted() {
    this.$nextTick(() => {
      this.maxWidth = this.$refs.imgbox.clientWidth;
    });
  },
  watch: {
    token: {
      immediate: true,
      handler() {
        this.$nextTick(() => {
          this.tips = this.content.tips;
          this.src = this.content.src;
          this.currentW = this.content.src ? this.content.style.width : "";
          this.onChange();
        });
      },
    },
  },
  methods: {
    onImage() {
      // 初始化默认宽度
      this.$nextTick(() => {
        let imgW = this.$refs.img.width;
        this.maxWidth = this.$refs.imgbox.clientWidth;
        let w = (imgW / this.maxWidth).toFixed(1);
        w = w * 100;
        w = w <= 20 ? 20 : w;
        w = w >= 100 ? 100 : w;
        this.currentW = w;
      });
      this.onChange();
    },
    // 放大
    amplify() {
      let w = this.currentW;
      w += 5;
      w = w >= 100 ? 100 : w;
      this.currentW = w;
      this.onChange();
    },
    // 缩小
    reduceImg() {
      let w = this.currentW;
      w -= 5;
      w = w <= 20 ? 20 : w;
      this.currentW = w;
      this.onChange();
    },
    onChange() {
      this.$emit("change", {
        src: this.src,
        tips: this.tips,
        style: {
          width: this.currentW,
        },
      });
    },
    // 选择图片
    onSelectImg(data) {
      if (data.target.files.length <= 0) return;
      let files = [...data.target.files];
      this.file = files[0];
      this.uploadImg();
    },
    uploadImg() {
      let file = this.file;
      var reader = new FileReader();
      reader.readAsDataURL(this.file);
      //监听文件读取结束后事件
      let that = this;
      reader.onloadend = async function (e) {
        that.loadingState = 0;
        that.src = reader.result;
        if (config.uploadImg) {
          that.loadingState = 1;
          let [err, data] = await config.uploadImg(file);
          if (err) {
            that.loadingState = 3;
          } else {
            that.loadingState = 2;
            that.src = data;
          }
        }
        that.onChange();
      };
    },
    // 删除图片
    deleteImg() {
      this.loadingState = 0;
      this.src = "";
      this.file = "";
      this.currentW = "";
      this.onChange();
    },
  },
};
</script>

<style lang="scss" scoped>
.image-one-section {
  // background: #fff;
}

// 内容区域
.image-one-section .image-one-content {
  display: flex;
  align-items: center;
  padding: 15px 15px 0;
  justify-content: center;
}

// 提示
.image-one-section .tips {
  text-align: center;
  font-size: 14px;
  color: #999;
  padding: 5px 10px 20px;
}
.image-one-section .tips input {
  color: #999;
  text-align: center;
  background: transparent;
}

.image-one-section .tips input::placeholder {
  color: #ccc;
}

.image-one-content .image-item {
  // width: 100%;
  background: #f5f5f5;
  display: flex;
  position: relative;
}
.image-item .del {
  width: 35px;
  height: 35px;
  position: absolute;
  right: 10px;
  top: 10px;
  background: rgba(0, 0, 0, 0.5);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}
.image-item .del img {
  width: 70%;
  height: 65%;
}
.image-item .loading-state {
  min-width: 35px;
  height: 35px;
  position: absolute;
  left: 50%;
  top: 10px;
  background: rgba(0, 0, 0, 0.5);
  border-radius: 5px;
  transform: translateX(-50%);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: #fff;
}
.image-item .loading-state span {
  padding: 0 10px;
  font-size: 14px;
}

.image-item .upload-err {
  color: rgb(245, 108, 108);
  text-align: center;
  padding: 2px 6px !important;
}

// 控制
.image-one-content .image-item .control {
  width: 100%;
  padding: 0 10px;
  display: none;
  position: absolute;
  bottom: 0;
  left: 0;
  box-sizing: border-box;
  background: rgba(0, 0, 0, 0.5);
  cursor: pointer;
  user-select: none;
}

.image-one-content .image-item .control span {
  flex: 1;
  padding: 10px;
  text-align: center;
  color: #fff;
}

.image-one-content:hover .control {
  display: flex;
}

// 上传图片
.select-image {
  width: 100%;
  height: 200px;
  text-align: center;
  line-height: 200px;
  position: relative;
  color: #ccc;
  background: #f5f5f5;
}
.select-image input {
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
}

.image-one-section .image-item .image-empty {
  height: 200px;
  width: 100%;
  background: #f5f5f5;
  display: flex;
  align-items: center;
  justify-content: center;
}
</style>
